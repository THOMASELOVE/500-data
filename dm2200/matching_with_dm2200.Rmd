---
title: "Propensity Matching and the dm2200 Data"
author: "Thomas E. Love, Ph.D."
date: "`r Sys.Date()`"
output: 
    github_document:
        toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA)
```

This document will eventually demonstrate multiple matching strategies incorporating the propensity score, including the assessment of covariate balance before and after matching. We focus on binary and quantitative outcomes in a (simulated) electronic health records data setting. It uses the `cobalt` package extensively.

- Greifer, N. (2020). cobalt: Covariate Balance Tables and Plots. R package version 4.0.0.

## Setup

```{r, message = FALSE}
library(skimr); library(tableone)
library(magrittr); library(janitor) 
library(broom); library(survival); library(lme4)
library(cobalt); library(Matching)
library(tidyverse)

theme_set(theme_bw())
```

```{r, message = FALSE}
dm2200 <- read_csv("data/dm2200.csv") %>% 
    type.convert() %>% # convert characters to factors
    mutate(subject = as.character(subject),
           bp_good = as.numeric(sbp < 140 & dbp < 90))

dm2200
```

# The `dm2200` data set

I've simulated data to match real information we've collected over the years at Better Health Partnership on adults who live with diabetes. These data mirror some of the real data colleted from electronic health records across the region by Better Health Partnership, but individual values have been permuted across patients, so the results are not applicable to any population. The data I simulated from was a subset of Better Health data that required that the subject fall into exactly one of the two exposure groups we'll study, that they live in Cuyahoga County, prefer English for health-related communications, and have no missing data on the variables we'll study. 

- The *exposure* we'll study is called `exposure` and consists of two levels: A and B. I won't specify the details further on how the exposure is determined, except to say that it is uniquely determinable for each subject.
- We'll study a binary outcome, specifically whether the subject's blood pressure is in control, in the sense that both their systolic blood pressure is below 140 mm Hg, *and* their diastolic blood pressure is below 90 mm Hg.
- We'll also study a continuous outcome, the subject's body-mass index or `bmi`.

## Codebook

*Note*: I used `paste(colnames(dm2200), collapse = " | ")` to help me make this list.

Variable | Type | Description
-----------: | :-----: | ---------------------------------------
subject | character | subject identifier (S-0001 to S-2200)
exposure | factor (2 levels) | A or B
age | integer | age in years
race | factor (4 levels) | White, Black_AA, Asian, Other
hisp | 1/0 | 1 = Hispanic or Latinx, 0 = not
sex | F/M | F = Female, M = Male
insur | factor (4 levels) | Insurance: Medicare, Commercial, Medicaid or Uninsured
nincome | integer | est. Neighborhood Median Income, in $
nhsgrad | integer | est. % of adults in Neighborhood who are High School graduates
cleve | 1/0 | 1 = Cleveland resident, 0 = resident of suburbs
height_cm | integer | height in cm
weight_kg | integer | weight in kg
bmi | numeric | body mass index (kg/m^2^)
a1c | numeric | most recent Hemoglobin A1c (in %)
sbp | numeric | most recent systolic blood pressure (in mm Hg)
dbp | numeric | most recent diastolic blood pressure (in mm Hg)
bp_good | 1/0 | 1 if `sbp` < 140 and `dbp` < 90, 0 otherwise
ldl | numeric | most recent LDL cholesterol (in mg/dl)
visits | integer | primary care office visits in past year
tobacco | factor (3 levels) | Tobacco use: Current, Former, Never
statin | 1/0 | 1 if subject had a statin prescription in the past year
ace_arb | 1/0 | 1 if subject had an ACE inhibitor or ARB prescription in the past year
betab | 1/0 | 1 if subject had a beta-blocker prescription in the past year
depr_dx | 1/0 | 1 if the subject has a depression diagnosis
eyeex | 1/0 | 1 if the subject has had a retinal eye exam in the past year
pneumo | 1/0 | 1 if the subject has had a pneumococcal vaccination in the past 10 years

## Comparing Exposure Groups with `tableone`

```{r}
t1 <- CreateTableOne(
    vars = c("age", "race", "hisp", "sex", "insur", 
             "nincome", "nhsgrad", "cleve", "sbp", "dbp",
             "ldl", "visits", "tobacco", "statin", 
             "ace_arb", "betab", "depr_dx", "eyeex", 
             "pneumo", "bmi", "bp_good"), 
    factorVars = c("hisp", "cleve", "statin",
                   "ace_arb", "betab", "depr_dx", 
                   "eyeex", "pneumo", "bp_good"),
    strata = "exposure", 
    data = dm2200)

t1
```

# Propensity for Exposure

We'll fit a logistic regression model to predict propensity for exposure `A` (as compared to `B`), on the basis of these 18 covariates:

- age, race, hisp, sex, insur, nincome, nhsgrad, cleve, 
- a1c, ldl, visits, tobacco, statin, ace_arb, betab, 
- depr_dx, eyeex, pneumo

Practically, we might well fit something more complex than a simple model with main effects, but that's what we'll limit ourselves to in this setting. Note that we're not including any direct information on either of our outcomes, or the elements that go into them. In practical work, we might fit different propensity scores for each outcome, but we're keeping things simple here.

## Fitting a Propensity Model

We'll use the `f.build` tool from the `cobalt` package here.

```{r}
dm2200 <- dm2200 %>%
    mutate(treat = as.logical(exposure == "A"))

covs_1 <- dm2200 %>%
    select(age, race, hisp, sex, insur, nincome,
           nhsgrad, cleve, a1c, ldl, visits, tobacco,
           statin, ace_arb, betab, depr_dx, eyeex, pneumo)

prop_model <- glm(f.build("treat", covs_1), data = dm2200,
                  family = binomial)

tidy(prop_model, conf.int = TRUE) %>%
    select(term, estimate, std.error, conf.low, conf.high, p.value) %>%
    knitr::kable(digits = 3)
```

```{r}
glance(prop_model)
```

### Storing the Propensity Scores

```{r}
dm2200 <- dm2200 %>%
    mutate(ps = prop_model$fitted,
           linps = prop_model$linear.predictors)

ggplot(dm2200, aes(x = exposure, y = linps)) +
    geom_violin() +
    geom_boxplot(width = 0.3)
```

# `match1` 1:1 greedy matching without replacement

We're going to match on the linear propensity score, and define our `treat` (treatment) as occurring when `exposure` is A.

```{r}
match_1 <- Match(Tr = dm2200$treat, X = dm2200$linps, 
                 M = 1, replace = FALSE, ties = FALSE,
                 estimand = "ATT")

summary(match_1)
```

## Obtaining the Matched Sample

Now, we build a new matched sample data frame in order to do some of the analyses to come. This will contain only the matched subjects.

```{r}
match1_matches <- factor(rep(match_1$index.treated, 2))
dm2200_matched1 <- cbind(match1_matches, 
                         dm2200[c(match_1$index.control, 
                                  match_1$index.treated),])
```

Some sanity checks:

```{r}
dm2200_matched1 %>% count(exposure)
```

```{r}
dm2200_matched1 %>% head()
```

## Checking Covariate Balance for our 1:1 Greedy Match

### Using `bal.tab` to obtain a balance table

```{r}
covs_1plus <- dm2200 %>%
    select(age, race, hisp, sex, insur, nincome,
           nhsgrad, cleve, a1c, ldl, visits, tobacco,
           statin, ace_arb, betab, depr_dx, eyeex, pneumo,
           ps, linps)

bal1 <- bal.tab(M = match_1,
                treat = dm2200$exposure,
                covs = covs_1plus, quick = FALSE,
                un = TRUE, disp.v.ratio = TRUE)
bal1
```

### Checking Rubin's Rules 1 and 2

We'll build a little table of the Rubin's Rules (1 and 2) before and after our `match_1` is applied.

```{r}
covs_2plus <- dm2200 %>%
    select(linps)

rubin_m1 <- bal.tab(M = match_1,
                treat = dm2200$treat,
                covs = covs_2plus, 
                un = TRUE, disp.v.ratio = TRUE)[1]

rubin_report_m1 <- tibble(
    status = c("Rule1", "Rule2"),
    Unmatched = c(rubin_m1$Balance$Diff.Un,
                  rubin_m1$Balance$V.Ratio.Un),
    Matched = c(rubin_m1$Balance$Diff.Adj,
               rubin_m1$Balance$V.Ratio.Adj))

rubin_report_m1 %>% knitr::kable(digits = 2)
```

- The Rule 1 results tell us about the standardized differences expressed as proportions, so we'd like to be certain that our results are as close to zero as possible, and definitely below 0.5 in absolute value.
    - Multiply these by 100 to describe them as percentages, adjusting the cutoff to below 50 in absolute value.
    - Here, before matching we have a bias of `r 100*rubin_report_m1[1,2]`%, and this is reduced to `r 100*rubin_report_m1[1,3]`% after 1:1 greedy matching.
- The Rule 2 results tell us about the variance ratio of the linear propensity scores. We want this to be within (0.5, 2) and ideally within (0.8, 1.25).
    - Here, before matching we have a variance ratio of `r 100*rubin_report_m1[2,2]`%, and this becomes `r 100*rubin_report_m1[2,3]`% after 1:1 greedy matching.


### Using `bal.plot` from `cobalt`

We can look at any particular variable with this approach, for example, age:

```{r}
bal.plot(obj = match_1,
         treat = dm2200$exposure,
         covs = covs_1plus,
         var.name = "age", 
         which = "both",
         sample.names = 
             c("Unmatched Sample", "Matched Sample"))
```

We could also look at the propensity scores in each group, perhaps in mirrored histograms, with ...

```{r}
bal.plot(obj = match_1,
         treat = dm2200$exposure,
         covs = covs_1plus,
         var.name = "ps", 
         which = "both",
         sample.names = 
             c("Unmatched Sample", "Matched Sample"),
         type = "histogram", mirror = TRUE)
```

Can we look at a categorical variable this way?

```{r}
bal.plot(obj = match_1,
         treat = dm2200$exposure,
         covs = covs_1plus,
         var.name = "insur", 
         which = "both",
         sample.names = 
             c("Unmatched Sample", "Matched Sample"))
```

### Using `love.plot` to look at Standardized Differences

```{r}
love.plot(bal1, 
          threshold = .1, size = 3,
          var.order = "unadjusted",
          stats = "mean.diffs",
          stars = "raw",
          sample.names = c("Unmatched", "Matched"),
          title = "Love Plot for our 1:1 Match") +
    labs(caption = "* indicates raw mean differences (for binary variables)")
```

```{r}
love.plot(bal1, 
          threshold = .1, size = 3,
          var.order = "unadjusted",
          stats = "mean.diffs",
          stars = "raw",
          abs = TRUE,
          sample.names = c("Unmatched", "Matched"),
          title = "Absolute Differences for 1:1 Match") +
    labs(caption = "* indicates raw mean differences (for binary variables)")
```

### Using `love.plot` to look at Variance Ratios

Note that this will only include the variables (and summaries like `ps` and `linps`) that describe quantities. Categorical variables are dropped.

```{r}
love.plot(bal1, 
          threshold = .5, size = 3,
          stats = "variance.ratios",
          sample.names = c("Unmatched", "Matched"),
          title = "Variance Ratios for our 1:1 Match") 
```

# Outcome Models

We'll fit two (overly simplistic) outcome models, one for `bp_good` (our binary outcome) and another for `bmi` (our quantitative outcome.) Later, we'll compare the `exposure` effect estimates made here to the estimates we obtain after propensity matching.

## Unadjusted Models prior to Propensity Matching

### Unadjusted Outcome Model for `bp_good`

```{r}
unadj_mod1 <- glm(bp_good == 1 ~ exposure == "A", data = dm2200, 
                  family = binomial())

tidy(unadj_mod1, exponentiate = TRUE, 
     conf.int = TRUE, conf.level = 0.95) %>%
    select(term, estimate, std.error, 
           conf.low, conf.high) %>%
    knitr::kable(digits = 3)
```

### Unadjusted Outcome Model for `bmi`

```{r}
unadj_mod2 <- lm(bmi ~ exposure == "A", data = dm2200)

tidy(unadj_mod2, conf.int = TRUE, conf.level = 0.95) %>%
    select(term, estimate, std.error, 
           conf.low, conf.high) %>%
    knitr::kable(digits = 3)
```

## Adjusted Outcome Models after `match1`

### Binary Outcome: `bp_good`

```{r}
result_match1_bp <- clogit(bp_good ~ (exposure == "A") + 
                          strata(match1_matches),
                      data = dm2200_matched1)

tidy(result_match1_bp, exponentiate = TRUE, conf.int = TRUE, conf.level = 0.95) %>%
    select(term, estimate, std.error, conf.low, conf.high) %>%
    knitr::kable(digits = 3)
```

### Quantitative Outcome: `bmi`

We'll use a mixed model to account for our 1:1 matching. The matches here are treated as a random factor, with the exposure a fixed factor, in the `lme4` package.

```{r}
dm2200_matched1 <- dm2200_matched1 %>% 
    mutate(match1_matches_f = as.factor(match1_matches))

result_match1_bmi <- lmer(bmi ~ (exposure == "A") + 
                              (1 | match1_matches_f), 
                          data = dm2200_matched1)

tidy(result_match1_bmi, 
     conf.int = TRUE, conf.level = 0.95) %>% 
    filter(group == "fixed") %>%
    select(term, estimate, std.error, 
           conf.low, conf.high) %>%
    knitr::kable(digits = 3)
```



## Key References

Matching was performed using the Matching package (Sekhon, 2011), and covariate balance was assessed using cobalt (Greifer, 2020), both in R (R Core Team, 2019).

- Greifer, N. (2020). cobalt: Covariate Balance Tables and Plots. R package version 4.0.0.